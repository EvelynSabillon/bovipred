<div class="prediction-container">
  <!-- Header -->
  <div class="header">
    <button class="btn-back" (click)="navigateBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Volver
    </button>
    <h1>üîÆ Predicciones de Pre√±ez con IA</h1>
    <button class="btn-create" *ngIf="canEdit()" (click)="openPredictionModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
      </svg>
      Nueva Predicci√≥n
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-section" *ngIf="stats && !loadingStats">
    <div class="stat-card">
      <div class="stat-icon stat-icon-total">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>Total Predicciones</h3>
        <p class="stat-value">{{ stats.total_predicciones }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-validadas">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4"/>
          <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>Validadas</h3>
        <p class="stat-value">{{ stats.predicciones_validadas }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-correctas">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>Correctas</h3>
        <p class="stat-value">{{ stats.predicciones_correctas }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-accuracy">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>Tasa de Acierto</h3>
        <p class="stat-value">{{ stats.tasa_acierto }}%</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-confianza">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>Confianza Promedio</h3>
        <p class="stat-value">{{ stats.promedio_confianza }}%</p>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>Nivel de Confianza</label>
        <select [(ngModel)]="filterNivelConfianza" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos</option>
          <option value="alto">Alto</option>
          <option value="medio">Medio</option>
          <option value="bajo">Bajo</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Estado de Validaci√≥n</label>
        <select [(ngModel)]="filterValidadas" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos</option>
          <option value="true">Validadas</option>
          <option value="false">Pendientes</option>
        </select>
      </div>

      <div class="filter-group">
        <button class="btn-clear-filters" (click)="clearFilters()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
          Limpiar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingPredictions" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando predicciones...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingPredictions && predictions.length === 0" class="empty-state">
    <svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
    </svg>
    <h3>No hay predicciones realizadas</h3>
    <p>Comienza a realizar predicciones de pre√±ez usando nuestro sistema de Machine Learning</p>
    <button class="btn-create-first" *ngIf="canEdit()" (click)="openPredictionModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
      </svg>
      Realizar Primera Predicci√≥n
    </button>
  </div>

  <!-- Predictions Table -->
  <div *ngIf="!loadingPredictions && predictions.length > 0" class="table-container">
    <table class="prediction-table">
      <thead>
        <tr>
          <th>Arete</th>
          <th>Probabilidad</th>
          <th>Nivel Confianza</th>
          <th>Modelo</th>
          <th>Fecha Predicci√≥n</th>
          <th>Resultado Real</th>
          <th>¬øCorrecta?</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prediction of predictions">
          <td>
            <div class="animal-info">
              <svg class="animal-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="8" r="4"/>
                <path d="M12 14c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/>
              </svg>
              <span>{{ prediction.iatf_record?.animal?.arete || 'N/A' }}</span>
            </div>
          </td>
          <td>
            <div class="probability-cell">
              <div class="probability-bar">
                <div 
                  class="probability-fill" 
                  [style.width.%]="prediction.probabilidad_prenez * 100"
                  [style.background-color]="getProbabilityColor(prediction.probabilidad_prenez)">
                </div>
              </div>
              <span class="probability-value">{{ formatProbability(prediction.probabilidad_prenez) }}</span>
            </div>
          </td>
          <td>
            <span [class]="'badge ' + getNivelConfianzaBadgeClass(prediction.nivel_confianza)">
              {{ getNivelConfianzaLabel(prediction.nivel_confianza) }}
            </span>
          </td>
          <td>
            <div class="modelo-info">
              <span class="modelo-nombre">{{ prediction.modelo_usado }}</span>
              <span class="modelo-version">v{{ prediction.version_modelo }}</span>
            </div>
          </td>
          <td>{{ prediction.created_at | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <span [class]="'badge ' + getResultadoBadgeClass(prediction.resultado_real)">
              {{ getResultadoLabel(prediction.resultado_real) }}
            </span>
          </td>
          <td>
            <span *ngIf="prediction.prediccion_correcta !== null" 
                  [class]="prediction.prediccion_correcta ? 'badge resultado-positivo' : 'badge resultado-negativo'">
              {{ prediction.prediccion_correcta ? '‚úì S√≠' : '‚úó No' }}
            </span>
            <span *ngIf="prediction.prediccion_correcta === null" class="text-muted">-</span>
          </td>
          <td>
            <div class="actions">
              <button 
                class="btn-action btn-detalle" 
                (click)="openDetalleModal(prediction)"
                title="Ver detalles">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4M12 8h.01"/>
                </svg>
              </button>
              <button 
                class="btn-action btn-resultado" 
                *ngIf="canEdit()"
                (click)="openResultadoModal(prediction)"
                title="Actualizar resultado real">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button 
        class="btn-page" 
        [disabled]="currentPage === 1"
        (click)="prevPage()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Anterior
      </button>
      <span class="page-info">P√°gina {{ currentPage }} de {{ totalPages }} ({{ totalRecords }} registros)</span>
      <button 
        class="btn-page" 
        [disabled]="currentPage === totalPages"
        (click)="nextPage()">
        Siguiente
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Realizar Predicci√≥n Modal -->
<div class="modal-overlay" *ngIf="showPredictionModal" (click)="closePredictionModal()">
  <div class="modal prediction-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üîÆ Realizar Nueva Predicci√≥n con IA</h2>
      <button class="btn-close" (click)="closePredictionModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="prediction-info-box">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <div>
          <p><strong>Sistema BOVIPRED - Machine Learning</strong></p>
          <p>Nuestro modelo de IA analizar√° m√°s de 16 variables reproductivas, fisiol√≥gicas y de manejo para predecir la probabilidad de pre√±ez con 75-85% de precisi√≥n.</p>
        </div>
      </div>

      <form>
        <div class="form-group">
          <label>Seleccionar Registro IATF *</label>
          <select [(ngModel)]="predictionForm.iatf_record_id" name="iatf_record_id" class="form-control" required>
            <option [ngValue]="0" disabled>Seleccionar registro IATF</option>
            <option *ngFor="let record of iatfRecords" [ngValue]="record.id">
              Arete: {{ record.animal?.arete }} - {{ record.animal?.nombre }} ({{ record.fecha_iatf | date:'dd/MM/yyyy' }})
            </option>
          </select>
          <small class="form-hint" *ngIf="iatfRecords.length === 0">
            No hay registros IATF disponibles. <a (click)="navigateToIatf()" class="link">Crear registro IATF</a>
          </small>
        </div>

        <div class="ml-features-info">
          <h4>ü§ñ El modelo analiza:</h4>
          <ul>
            <li>‚úì Condici√≥n ov√°rica bilateral</li>
            <li>‚úì Tono uterino y tratamiento</li>
            <li>‚úì Condici√≥n corporal y edad</li>
            <li>‚úì D√≠as posparto y partos previos</li>
            <li>‚úì Protocolos de tonificaci√≥n</li>
            <li>‚úì Calidad del semental</li>
            <li>‚úì Variables ambientales</li>
          </ul>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closePredictionModal()" [disabled]="realizandoPrediccion">
        Cancelar
      </button>
      <button class="btn-save btn-predict" (click)="realizarPrediccion()" [disabled]="realizandoPrediccion || predictionForm.iatf_record_id === 0">
        <span *ngIf="!realizandoPrediccion">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
          Realizar Predicci√≥n
        </span>
        <span *ngIf="realizandoPrediccion" class="loading-text">
          <span class="spinner-small"></span>
          Analizando con IA...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Resultado Modal -->
<div class="modal-overlay" *ngIf="showResultadoModal" (click)="closeResultadoModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üìã Actualizar Resultado Real</h2>
      <button class="btn-close" (click)="closeResultadoModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="resultado-info" *ngIf="selectedPrediction">
        <p><strong>Animal:</strong> {{ selectedPrediction.iatf_record?.animal?.arete }}</p>
        <p><strong>Probabilidad predicha:</strong> {{ formatProbability(selectedPrediction.probabilidad_prenez) }}</p>
        <p><strong>Predicci√≥n:</strong> {{ selectedPrediction.prediccion_binaria ? 'Gestante' : 'No Gestante' }}</p>
      </div>

      <form>
        <div class="form-group">
          <label>Resultado Real (Confirmaci√≥n) *</label>
          <div class="radio-group-resultado">
            <label class="radio-option-resultado">
              <input 
                type="radio" 
                name="resultado" 
                [value]="true" 
                [(ngModel)]="resultadoForm.resultado_real">
              <span class="radio-label positivo">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Positivo - Pre√±ada
              </span>
            </label>
            <label class="radio-option-resultado">
              <input 
                type="radio" 
                name="resultado" 
                [value]="false" 
                [(ngModel)]="resultadoForm.resultado_real">
              <span class="radio-label negativo">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
                Negativo - No Pre√±ada
              </span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>Fecha de Verificaci√≥n *</label>
          <input 
            type="date" 
            [(ngModel)]="resultadoForm.fecha_verificacion" 
            name="fecha_verificacion"
            class="form-control"
            required>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeResultadoModal()" [disabled]="actualizandoResultado">
        Cancelar
      </button>
      <button class="btn-save" (click)="saveResultado()" [disabled]="actualizandoResultado">
        <span *ngIf="!actualizandoResultado">Guardar Resultado</span>
        <span *ngIf="actualizandoResultado" class="loading-text">
          <span class="spinner-small"></span>
          Guardando...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Detalle Modal -->
<div class="modal-overlay" *ngIf="showDetalleModal" (click)="closeDetalleModal()">
  <div class="modal modal-detalle" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üìä Detalles de la Predicci√≥n</h2>
      <button class="btn-close" (click)="closeDetalleModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedPrediction">
      
      <!-- Info General -->
      <div class="detalle-section">
        <h3>Informaci√≥n General</h3>
        <div class="detalle-grid">
          <div class="detalle-item">
            <span class="detalle-label">Animal:</span>
            <span class="detalle-value">{{ selectedPrediction.iatf_record?.animal?.arete }} - {{ selectedPrediction.iatf_record?.animal?.nombre }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Probabilidad:</span>
            <span class="detalle-value">{{ formatProbability(selectedPrediction.probabilidad_prenez) }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Predicci√≥n:</span>
            <span [class]="'badge ' + (selectedPrediction.prediccion_binaria ? 'resultado-positivo' : 'resultado-negativo')">
              {{ selectedPrediction.prediccion_binaria ? 'Gestante' : 'No Gestante' }}
            </span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Nivel de Confianza:</span>
            <span [class]="'badge ' + getNivelConfianzaBadgeClass(selectedPrediction.nivel_confianza)">
              {{ getNivelConfianzaLabel(selectedPrediction.nivel_confianza) }}
            </span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Modelo:</span>
            <span class="detalle-value">{{ selectedPrediction.modelo_usado }} v{{ selectedPrediction.version_modelo }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Fecha:</span>
            <span class="detalle-value">{{ selectedPrediction.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>

      <!-- M√©tricas del Modelo -->
      <div class="detalle-section">
        <h3>M√©tricas del Modelo</h3>
        <div class="metricas-grid">
          <div class="metrica-card">
            <span class="metrica-label">Accuracy</span>
            <span class="metrica-value">{{ formatMetric(selectedPrediction.accuracy) }}</span>
          </div>
          <div class="metrica-card">
            <span class="metrica-label">Precision</span>
            <span class="metrica-value">{{ formatMetric(selectedPrediction.precision) }}</span>
          </div>
          <div class="metrica-card">
            <span class="metrica-label">Recall</span>
            <span class="metrica-value">{{ formatMetric(selectedPrediction.recall) }}</span>
          </div>
          <div class="metrica-card">
            <span class="metrica-label">F1-Score</span>
            <span class="metrica-value">{{ formatMetric(selectedPrediction.f1_score) }}</span>
          </div>
          <div class="metrica-card">
            <span class="metrica-label">AUC-ROC</span>
            <span class="metrica-value">{{ formatMetric(selectedPrediction.roc_auc) }}</span>
          </div>
        </div>
      </div>

      <!-- Top Features -->
      <div class="detalle-section" *ngIf="getTopFeatures(selectedPrediction).length > 0">
        <h3>Variables M√°s Importantes</h3>
        <div class="features-list">
          <div class="feature-item" *ngFor="let feature of getTopFeatures(selectedPrediction)">
            <div class="feature-info">
              <span class="feature-name">{{ formatFeatureName(feature.feature) }}</span>
              <span class="feature-importance">{{ (feature.importance * 100).toFixed(1) }}%</span>
            </div>
            <div class="feature-bar">
              <div class="feature-fill" [style.width.%]="feature.importance * 100"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recomendaciones -->
      <div class="detalle-section" *ngIf="getRecomendaciones(selectedPrediction).length > 0">
        <h3>Recomendaciones</h3>
        <div class="recomendaciones-list">
          <div class="recomendacion-item" *ngFor="let recomendacion of getRecomendaciones(selectedPrediction)">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5"/>
            </svg>
            <span>{{ recomendacion }}</span>
          </div>
        </div>
      </div>

      <!-- Resultado Real -->
      <div class="detalle-section" *ngIf="selectedPrediction.resultado_real !== null">
        <h3>Validaci√≥n</h3>
        <div class="detalle-grid">
          <div class="detalle-item">
            <span class="detalle-label">Resultado Real:</span>
            <span [class]="'badge ' + getResultadoBadgeClass(selectedPrediction.resultado_real)">
              {{ getResultadoLabel(selectedPrediction.resultado_real) }}
            </span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Predicci√≥n Correcta:</span>
            <span [class]="'badge ' + (selectedPrediction.prediccion_correcta ? 'resultado-positivo' : 'resultado-negativo')">
              {{ selectedPrediction.prediccion_correcta ? '‚úì S√≠' : '‚úó No' }}
            </span>
          </div>
          <div class="detalle-item" *ngIf="selectedPrediction.fecha_verificacion">
            <span class="detalle-label">Fecha Verificaci√≥n:</span>
            <span class="detalle-value">{{ selectedPrediction.fecha_verificacion | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-save" (click)="closeDetalleModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal-overlay-success" *ngIf="showSuccessModal">
  <div class="modal modal-success">
    <div class="modal-header-success">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    </div>
    <div class="modal-body">
      <p class="success-message">{{ successMessage }}</p>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal-overlay-error" *ngIf="showErrorModal">
  <div class="modal modal-error">
    <div class="modal-header-error">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <div class="modal-body">
      <p class="error-message">{{ errorMessage }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-error" (click)="closeErrorModal()">Cerrar</button>
    </div>
  </div>
</div>